- local_action: command date +%s
  register: timestamp

- file: path={{ item }} state=directory recurse=yes mode=755
  with_items:
    - "/home/{{ ansible_ssh_user }}"
    - "{{ deploy_root }}"
    - "{{ releases_path }}"
    - "{{ shared_path }}"

- file: path="{{ releases_path }}/{{ timestamp.stdout }}" state=directory mode=701
  register: release_path

- git: repo={{ rackup_repo }} version={{ rackup_version }} dest={{ release_path.path }} update=yes depth=1

- template: src=unicorn.conf.rb dest="{{ release_path.path }}/unicorn.conf.rb"

- shell: chdir={{ release_path.path }} {{ item }}
  with_items: rackup_cmds
  environment: env
  notify:
    - rbenv rehash

- file: path={{ current_path }} src={{ release_path.path }} state=link
  environment: env
  notify:
    - restart unicorn
